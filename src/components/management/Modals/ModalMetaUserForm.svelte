<script lang="ts">
    import {
        Card,
        Label,
        Input,
        Checkbox,
        Button,
        Textarea,
        Accordion,
        AccordionItem,
        Select,
        Helper
    } from 'flowbite-svelte';
    import { PlusOutline } from 'flowbite-svelte-icons';

    let {
        formData = $bindable(),
        validateFn = $bindable()
    } = $props();

    let form;

    formData = {
        ...formData,
        email: formData.email || null,
        password: formData.password || null,
        msisdn: formData.msisdn || null,
        is_email_verified: formData.is_email_verified || false,
        is_msisdn_verified: formData.is_msisdn_verified || false,
        force_password_change: formData.force_password_change || false,
        type: formData.type || 'mobile',
        language: formData.language || null,
        roles: formData.roles || [],
        groups: formData.groups || [],
        firebase_token: formData.firebase_token || null,
        google_id: formData.google_id || null,
        facebook_id: formData.facebook_id || null,
        social_avatar_url: formData.social_avatar_url || null
    }

    const userTypeOptions = ["bot", "mobile", "web", "admin", "api"]
        .map(type => ({ name: type.charAt(0).toUpperCase() + type.slice(1), value: type }));

    let newRole = '';
    let newGroup = '';

    function addRole() {
        if (newRole && !formData.roles.includes(newRole)) {
            formData.roles = [...formData.roles, newRole];
            newRole = '';
        }
    }

    function removeRole(role) {
        formData.roles = formData.roles.filter(r => r !== role);
    }

    function addGroup() {
        if (newGroup && !formData.groups.includes(newGroup)) {
            formData.groups = [...formData.groups, newGroup];
            newGroup = '';
        }
    }

    function removeGroup(group) {
        formData.groups = formData.groups.filter(g => g !== group);
    }

    function validate() {
        const isValid = form.checkValidity();

        if (!isValid) {
            form.reportValidity();
        }

        return isValid;
    }

    $effect(() => {
        validateFn = validate;
    });
</script>

<Card class="w-full max-w-4xl mx-auto p-4">
    <h2 class="text-2xl font-bold mb-4">User Information</h2>

    <form bind:this={form} class="space-y-4">
        <div class="mb-4">
            <Label for="password" class="mb-2">
                <span class="text-red-500 text-lg" style="vertical-align: center">*</span>
                Password
            </Label>
            <Input required
                   id="password"
                   type="password"
                   placeholder="••••••••"
                   bind:value={formData.password}
                   minlength="8" />
            <Helper class="mt-1">Minimum 8 characters</Helper>
        </div>

        <div class="mb-4">
            <Label for="email" class="mb-2">Email</Label>
            <Input
                    id="email"
                    type="email"
                    placeholder="user@example.com"
                    bind:value={formData.email}
                    pattern="[a-z0-9._%+\-]+@[a-z0-9.\-]+\.[a-z]$" />
        </div>

        <div class="mb-4">
            <Label for="msisdn" class="mb-2">Mobile Number (MSISDN)</Label>
            <Input
                    id="msisdn"
                    placeholder="+964723456789 / 0712345678"
                    bind:value={formData.msisdn}
                    pattern="^\[1-9]\d$" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="flex items-center">
                <Checkbox id="force_password_change" bind:checked={formData.force_password_change} />
                <Label for="force_password_change" class="ml-2">Force Password Change</Label>
            </div>
            <div class="flex items-center">
                <Checkbox id="is_email_verified" bind:checked={formData.is_email_verified} />
                <Label for="is_email_verified" class="ml-2">Email Verified</Label>
            </div>
            <div class="flex items-center">
                <Checkbox id="is_msisdn_verified" bind:checked={formData.is_msisdn_verified} />
                <Label for="is_msisdn_verified" class="ml-2">Phone Number Verified</Label>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <Label for="user_type" class="mb-2">User Type</Label>
                <Select id="user_type" items={userTypeOptions} bind:value={formData.type} />
            </div>
            <div>
                <Label for="language" class="mb-2">Preferred Language</Label>
                <Input id="language" bind:value={formData.language} />
            </div>
        </div>

        <Accordion>
            <AccordionItem>
                {#snippet header()}Roles and Groups{/snippet}
                <div class="p-4 space-y-4">
                    <div class="mb-4">
                        <Label class="mb-2">Roles</Label>
                        <div class="flex space-x-2">
                            <Input placeholder="Add new role" bind:value={newRole} />
                            <Button class="bg-primary" size="sm" onclick={addRole}>
                                <PlusOutline size="md" />
                            </Button>
                        </div>

                        {#if formData.roles.length > 0}
                            <div class="mt-2 flex flex-wrap gap-2">
                                {#each formData.roles as role}
                                    <div class="bg-gray-100 px-2 py-1 rounded-md flex items-center">
                                        <span>{role}</span>
                                        <button class="ml-2 text-gray-500" onclick={() => removeRole(role)}>
                                            ×
                                        </button>
                                    </div>
                                {/each}
                            </div>
                        {/if}
                    </div>

                    <div class="mb-4">
                        <Label class="mb-2">Groups</Label>
                        <div class="flex space-x-2">
                            <Input placeholder="Add new group" bind:value={newGroup} />
                            <Button class="bg-primary" size="sm" onclick={addGroup}><PlusOutline size="md" /></Button>
                        </div>

                        {#if formData.groups.length > 0}
                            <div class="mt-2 flex flex-wrap gap-2">
                                {#each formData.groups as group}
                                    <div class="bg-gray-100 px-2 py-1 rounded-md flex items-center">
                                        <span>{group}</span>
                                        <button class="ml-2 text-gray-500" onclick={() => removeGroup(group)}>
                                            ×
                                        </button>
                                    </div>
                                {/each}
                            </div>
                        {/if}
                    </div>
                </div>
            </AccordionItem>

            <AccordionItem>
                {#snippet header()}Social and External IDs{/snippet}
                <div class="p-4 space-y-4">
                    <div class="mb-4">
                        <Label for="firebase_token" class="mb-2">Firebase Token</Label>
                        <Textarea id="firebase_token" placeholder="Firebase authentication token" bind:value={formData.firebase_token} rows={2} />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <Label for="google_id" class="mb-2">Google ID</Label>
                            <Input id="google_id" bind:value={formData.google_id} />
                        </div>
                        <div>
                            <Label for="facebook_id" class="mb-2">Facebook ID</Label>
                            <Input id="facebook_id" bind:value={formData.facebook_id} />
                        </div>
                    </div>

                    <div>
                        <Label for="social_avatar_url" class="mb-2">Social Profile Image URL</Label>
                        <Input id="social_avatar_url" type="url" bind:value={formData.social_avatar_url} />
                    </div>
                </div>
            </AccordionItem>
        </Accordion>
    </form>
</Card>